<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MailSlit - Login with Gmail</title>
    <link rel="stylesheet" href="style.css"> <!-- Optional CSS -->
</head>
<body>
    <div class="container">
        <h1>Welcome to MailSlit</h1>
        <p>Click the button below to log in to your Gmail account and manage your subscriptions.</p>
        <a href="/authorize" class="login-btn">Login with Gmail</a>
    
        <div class="email-section">
            <h2>Manage Your Subscription Emails</h2>
            <label for="sortOptions">Sort Emails:</label>
            <select id="sortOptions">
                <option value="highest">Highest to Lowest</option>
                <option value="lowest">Lowest to Highest</option>
            </select>
            <button id="fetchEmailsButton">Fetch Emails</button> <!-- Fetch Emails Button -->
            <div id="emails"></div>
        </div>
    </div>
    

   <script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM fully loaded and parsed');
        
        const sortOptions = document.getElementById('sortOptions');
        const emailContainer = document.getElementById('emails');

         // Function to extract the authorization code from the URL and send it to the backend
         async function extractAuthCode() {
            console.log('Extracting authorization code from URL');
            const urlParams = new URLSearchParams(window.location.search); // Get URL parameters
            const code = urlParams.get('code'); // Extract the 'code' parameter
            if (!code) {
                console.error('No code found in URL parameters.');
                return [];
            }

            try {
                console.log('Sending request to /getEmails endpoint');
                // Send the code in the request body to the backend
                const response = await fetch('/getEmails', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ code }), 
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Emails fetched successfully', result.filteredEmails);
                    return result.filteredEmails;  // Extract filteredEmails from the response
                } else {
                    console.error('Failed to fetch emails. Status:', response.status);
                    return {};
                }
            } catch (error) {
                console.error('Error occurred while fetching emails:', error);
                return {};
            }
        }

        // Fetch emails from the backend
        async function fetchEmails() {
            console.log('Fetching emails from backend');
            return await extractAuthCode(); 
        }

        // Function to sort emails
        function sortEmails(emails, sortValue) {
            console.log('Sorting emails:', sortValue);
            const sortedEmails = Object.entries(emails).sort(([, a], [, b]) => {
                return sortValue === 'highest' ? b - a : a - b;
            });
            return sortedEmails;
        }

        // Function to display emails in the DOM
        function displayEmails(emails) {
            console.log('Displaying emails');
            emailContainer.innerHTML = ''; // Clear existing emails
            emails.forEach(([email, count]) => {
                const emailDiv = document.createElement('div');
                emailDiv.textContent = `${email} - ${count} messages`;
                emailContainer.appendChild(emailDiv);
            });
        }

        // Event listener for sort options
        sortOptions.addEventListener('change', async () => {
            console.log('Sort option changed');
            const sortValue = sortOptions.value;
            const emails = emailContainer.innerHTML ? JSON.parse(emailContainer.getAttribute('data-emails')) : await fetchEmails();
            const sortedEmails = sortEmails(emails, sortValue); // Sort emails based on selection
            displayEmails(sortedEmails); // Display sorted emails
        });

        // Event listener for fetch emails button
        document.getElementById('fetchEmailsButton').addEventListener('click', async () => {
            console.log('Fetch Emails button clicked');
            const emails = await fetchEmails(); // Call the function to fetch emails
            const sortValue = sortOptions.value;
            const sortedEmails = sortEmails(emails, sortValue);
            displayEmails(sortedEmails); // Display the fetched emails
            emailContainer.setAttribute('data-emails', JSON.stringify(emails));
        });
    });
</script>
    
</body>
</html>
